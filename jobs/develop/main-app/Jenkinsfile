pipeline {
    agent any

    tools {
        maven "Maven 3"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '5'))
    }

    stages {
        stage("Cloning Repo") {
         steps {
            git branch: "develop",
                credentialsId: "b35f24b1-359a-41b4-a342-c1bddbd4b9b8",
                url: "https://github.com/EMAsphere/emasphere.git"
         }
        }
        stage("Build") {
            steps {
                withMaven(maven: 'Maven 3') {
                    sh "mvn clean install -pl ${SERVICE_ROOT_PATH}/${SERVICE_MODULE_NAME} -B -DskipTests -Pci --also-make"
                }
            }
        }
        stage("Test") {
            steps {
                withMaven(maven: 'Maven 3') {
                    sh "cd ${SERVICE_ROOT_PATH} && mvn test -Pci"
                }
            }
            post {
                changed {
                    emailext subject: '$DEFAULT_SUBJECT',
                        body: '$DEFAULT_CONTENT',
                        recipientProviders: [
                            [$class: 'CulpritsRecipientProvider'],
                            [$class: 'DevelopersRecipientProvider'],
                            [$class: 'RequesterRecipientProvider']
                        ],
                        replyTo: '$DEFAULT_REPLYTO',
                        to: '$DEFAULT_RECIPIENTS'
                }
            }
        }
    }
}

